<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:difxapp="http://schemas.microsoft.com/wix/DifxAppExtension">

  <Product Id="1F88DEFF-32DB-47B3-AC40-0BC0F2CF2CD1" Name="CoCoiButtonAppx64"
           Language="1033" Version="1.0.1"
           Manufacturer="JusBMX"
           UpgradeCode="823F06D9-F72C-4F03-A1FA-954F7F3B8AB9">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"
             InstallPrivileges="elevated"/>
    <!-- Pre-Install conditions here -->
    <Condition Message="You need to be an administrator to install this product.">
      Privileged
    </Condition>
    <Condition Message="This CoCoiButtonApp Install is targeted only for 64-bit Microsoft operating systems.  Please use the appropriate version.">
      VersionNT64
    </Condition>

    <Media Id="1" Cabinet="_CoCoiButtonApp_x64.cab" EmbedCab="yes"/>

    <!-- Specify license agreement and custom images instead of WIX's defaults  -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf"/>
    <WixVariable Id="WixUIBannerBmp" Value="..\Files\Pics\bannrbmp.bmp"/>
    <WixVariable Id="WixUIDialogBmp" Value="..\Files\Pics\dlgbmp.bmp" />

    <!-- Setup Directory Structure on PC -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="ManufacturerSubFolder" Name="CoCo iButton App">
          <Directory Id="APPLICATIONROOTDIRECTORY" Name="1-Wire Drivers x64">
            <Directory Id="Driver_x64" Name="WinUSB_Driver"/>
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="SystemFolder">
        <!-- This needs to be here, so we can reference it later -->
      </Directory>
      <Directory Id="System64Folder">
        <!-- This needs to be here, so we can reference it later -->
      </Directory>
      <!-- Define the directory structure for Program shortcuts -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="CoCo iButton App x64"/>
      </Directory>
    </Directory>

    <!-- Put files in directories -->

    <DirectoryRef Id="Driver_x64">
      <Component Id="WinUSB_x64_Driver_Package" Guid="{7AC71227-194D-41be-B322-FFB13B9258EB}" Win64="yes">
        <difxapp:Driver AddRemovePrograms="no" DeleteFiles="no" ForceInstall="no" Legacy="no" PlugAndPlayPrompt="no" />
        <!-- WinUSB files -->
        <File Id="ds2490winusb_amd64.cat" Source="..\Files\Drivers\WinUSB\amd64\ds2490winusb_amd64.cat" Vital="yes" Checksum="yes" />
        <File Id="ds2490winusb_amd64.inf" Source="..\Files\Drivers\WinUSB\amd64\ds2490winusb_amd64.inf" Vital="yes" Checksum="yes" />
        <File Id="WdfCoInstaller01009_amd64.dll" Source="..\Files\Drivers\WinUSB\amd64\WdfCoInstaller01009.dll" Vital="yes" Checksum="yes" />
        <File Id="WUDFUpdate_01009_amd64.dll" Source="..\Files\Drivers\WinUSB\amd64\WUDFUpdate_01009.dll" Vital="yes" Checksum="yes" />
        <File Id="winusbcoinstaller2_amd64.dll" Source="..\Files\Drivers\WinUSB\amd64\winusbcoinstaller2.dll" Vital="yes" Checksum="yes" />
      </Component>
    </DirectoryRef>

    <!-- 64-bit TMEX files -->

    <DirectoryRef Id="System64Folder">
      <Component Id="IB97E64" Guid="{8EC0A4C1-F162-4efb-BFC6-C25FBB62B9FE}" Win64="yes">
        <File Id="IB97E64.dll" Source="..\Files\TMEXdlls_x64\IB97E64.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id="RemoveIB97E64.dll" On="uninstall" Name="IB97E64.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="IB97U64" Guid="{ECA4C10F-062B-4d47-81B0-A68849A30E20}" Win64="yes">
        <File Id="IB97U64.dll" Source="..\Files\TMEXdlls_x64\IB97U64.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id="RemoveIB97U64.dll" On="uninstall" Name="IB97U64.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="IBFS64" Guid="{B60D8F07-21A4-458e-B45F-9816337C48DC}" Win64="yes">
        <File Id="IBFS64.dll" Source="..\Files\TMEXdlls_x64\IBFS64.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id ="RemoveIBFS64.dll" On="uninstall" Name="IBFS64.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="IBUSB64" Guid="{E01F5556-2621-4c2d-89D5-C67DAA543209}" Win64="yes">
        <File Id="IBUSB64.dll" Source="..\Files\TMEXdlls_x64\IBUSB64.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id="RemoveIBUSB64.dll" On="uninstall" Name="IBUSB64.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="IBTMJAVA_x64" Guid="{34A4D6A0-3350-4413-91BF-743438ECD990}" Win64="yes">
        <File Id="IBTMJAVA_x64.dll" Source="..\Files\TMEXdlls_x64\ibtmjava64.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id ="RemoveIBTMJAVA_x64.dll" On="uninstall" Name="ibtmjava64.dll"/>
      </Component>
    </DirectoryRef>

    <!-- 32-bit TMEX files -->

    <DirectoryRef Id="SystemFolder">
      <Component Id="IB97E32" Guid="{5AD27412-4782-4552-960F-047C7260C3B5}">
        <File Id="IB97E32.dll" Source="..\Files\TMEXdlls\IB97E32.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id="RemoveIB97E32.dll" On="uninstall" Name="IB97E32.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SystemFolder">
      <Component Id="IB97U32" Guid="{A720C501-7185-4285-92CE-1F007980448D}">
        <File Id="IB97U32.dll" Source="..\Files\TMEXdlls\IB97U32.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id="RemoveIB97U32.dll" On="uninstall" Name="IB97U32.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SystemFolder">
      <Component Id="IBFS32" Guid="{F6A11C46-B690-4dd3-9C64-D243FB418499}">
        <File Id="IBFS32.dll" Source="..\Files\TMEXdlls\IBFS32.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id ="RemoveIBFS32.dll" On="uninstall" Name="IBFS32.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SystemFolder">
      <Component Id="IBUSB32" Guid="{888C998D-FD0C-4400-8B3C-3197736B4F0A}">
        <File Id="IBUSB32.dll" Source="..\Files\TMEXdlls\IBUSB32.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id="RemoveIBUSB32.dll" On="uninstall" Name="IBUSB32.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SystemFolder">
      <Component Id="IBTMJAVA" Guid="{E26CC7DF-EC24-4cda-8727-240C953A98B1}">
        <File Id="IBTMJAVA.dll" Source="..\Files\TMEXdlls\IBTMJAVA.dll" Vital="yes" Checksum="yes" />
        <RemoveFile Id ="RemoveIBTMJAVA.dll" On="uninstall" Name="IBTMJAVA.dll"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="TMEX64RegistryKeys" Guid="{D3CA8BEA-8820-4818-83CE-9AC91FB8CDAE}" Win64="yes">
        <!-- TMEX64 registry keys. -->
        <RegistryValue Id="TMEX64_DefaultPortNum" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="DefaultPortNum" Type="string" Value="1" Action="write" />
        <RegistryValue Id="TMEX64_DefaultPortType" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="DefaultPortType" Type="string" Value="6" Action="write" />
        <RegistryValue Id="TMEX64_MainDriver" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="MainDriver" Type="string" Value="IBFS64.dll" Action="write" />
        <RegistryValue Id="TMEX64_TYPE1" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="TYPE1" Type="string" Value="IB97E64.dll" Action="write" />
        <RegistryValue Id="TMEX64_TYPE5" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="TYPE5" Type="string" Value="IB97U64.dll" Action="write" />
        <RegistryValue Id="TMEX64_TYPE6" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="TYPE6" Type="string" Value="IBUSB64.dll" Action="write" />
        <RegistryValue Id="TMEX64_DebugLevel" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="DebugLevel" Type="string" Value="0" Action="write" />
        <RegistryValue Id="TMEX64_DebugFile" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="DebugFile" Type="string" Value="c:\\onewirelog.txt" Action="write" />
        <RegistryValue Id="TMEX64_AltFlexSettings" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers\x64" Name="AltFlexSettings" Type="string" Value="0" Action="write" />
        <RemoveRegistryKey Id ="RemoveHKLMRegistryKeyOnUninstall_x64" Root ="HKLM" Key ="Software\Maxim Integrated Products\1-Wire Drivers\x64" Action ="removeOnUninstall"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="TMEX32RegistryKeys" Guid="{2DD1E611-A8A5-4300-95A5-F89E60BBAE46}" Win64="yes">
        <!-- TMEX32 registry keys. -->
        <RegistryValue Id="TMEX32_DefaultPortNum" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="DefaultPortNum" Type="string" Value="1" Action="write" />
        <RegistryValue Id="TMEX32_DefaultPortType" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="DefaultPortType" Type="string" Value="6" Action="write" />
        <RegistryValue Id="TMEX32_MainDriver" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="MainDriver" Type="string" Value="IBFS32.dll" Action="write" />
        <RegistryValue Id="TMEX32_TYPE1" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="TYPE1" Type="string" Value="IB97E32.dll" Action="write" />
        <RegistryValue Id="TMEX32_TYPE5" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="TYPE5" Type="string" Value="IB97U32.dll" Action="write" />
        <RegistryValue Id="TMEX32_TYPE6" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="TYPE6" Type="string" Value="IBUSB32.dll" Action="write" />
        <RegistryValue Id="TMEX32_DebugLevel" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="DebugLevel" Type="string" Value="0" Action="write" />
        <RegistryValue Id="TMEX32_DebugFile" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="DebugFile" Type="string" Value="c:\\onewirelog.txt" Action="write" />
        <RegistryValue Id="TMEX32_AltFlexSettings" Root="HKLM" Key="Software\Maxim Integrated Products\1-Wire Drivers" Name="AltFlexSettings" Type="string" Value="0" Action="write" />
        <RemoveRegistryKey Id ="RemoveHKLMRegistryKeyOnUninstall" Root ="HKLM" Key ="Software\Maxim Integrated Products\1-Wire Drivers" Action ="removeOnUninstall"/>
      </Component>
    </DirectoryRef>

    <!-- Add the shortcuts to installer package -->

    <Feature Id="MainApplication" Title="1-Wire Drivers x64" Level="1">
      <ComponentRef Id="WinUSB_x64_Driver_Package"/>
      <ComponentRef Id="TMEX64RegistryKeys"/>
      <ComponentRef Id="IB97E64"/>
      <ComponentRef Id="IB97U64"/>
      <ComponentRef Id="IBFS64"/>
      <ComponentRef Id="IBUSB64"/>
      <ComponentRef Id="IBTMJAVA_x64"/>
      <ComponentRef Id="TMEX32RegistryKeys"/>
      <ComponentRef Id="IB97E32"/>
      <ComponentRef Id="IB97U32"/>
      <ComponentRef Id="IBFS32"/>
      <ComponentRef Id="IBUSB32"/>
      <ComponentRef Id="IBTMJAVA"/>
    </Feature>
    <!-- Here's the User Interface (UI)-->
    <Property Id="WIXUI_INSTALLDIR" Value="APPLICATIONROOTDIRECTORY"/>
    <UIRef Id="WixUI_InstallDir" />
    <!--<UIRef Id="WixUI_Minimal" />  To change to WixUI_Minimal, comment out the above two lines and uncomment this one -->
    <UIRef Id="WixUI_ErrorProgressText" />
  </Product>
</Wix>